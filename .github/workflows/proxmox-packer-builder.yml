name: Build Proxmox Packer Template

on:
  workflow_dispatch:
    inputs:
      vm_id:
        description: 'VM Template ID'
        required: false
        default: '9000'
        type: string
      force_build:
        description: 'Force build even if template exists'
        required: false
        default: false
        type: boolean
  push:
    branches:
      - main
    paths:
      - 'infrastructure_tooling/proxmox/packer/**'
  pull_request:
    branches:
      - main
    paths:
      - 'infrastructure_tooling/proxmox/packer/**'

env:
  PACKER_VERSION: "1.10.0"
  WORKING_DIR: "infrastructure_tooling/proxmox/packer/ubuntu-server-noble"

jobs:
  validate:
    name: Validate Packer Template
    runs-on: [self-hosted, Linux, X64]
    environment: prod
    outputs:
      template_valid: ${{ steps.validate.outputs.valid }}
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Initialize Packer
        working-directory: ${{ env.WORKING_DIR }}
        run: packer init ubuntu-2404.pkr.hcl

      - name: Create Variables File
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          cat > variables.pkrvars.hcl << EOF
          # Proxmox connection details
          proxmox_url      = "${{ secrets.PROXMOX_URL }}"
          proxmox_username = "${{ secrets.PROXMOX_USERNAME || 'root@pam!packer' }}"

          # VM template configuration
          vm_id        = "9000"
          proxmox_node = "${{ secrets.PROXMOX_NODE || 'proxmox' }}"

          # ISO and installation settings
          iso_file     = "local:iso/ubuntu-24.04.2-live-server-amd64.iso"
          ssh_username = "ubuntu"
          EOF

      - name: Validate Packer Template
        id: validate
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          packer validate \
            -var "proxmox_token=${{ secrets.PROXMOX_TOKEN }}" \
            -var "ssh_password=${{ secrets.SSH_PASSWORD }}" \
            -var-file="variables.pkrvars.hcl" \
            ubuntu-2404.pkr.hcl
          echo "valid=true" >> $GITHUB_OUTPUT

  build:
    name: Build Proxmox Template
    runs-on: [self-hosted, Linux, X64]
    needs: validate
    if: needs.validate.outputs.template_valid == 'true'
    environment: prod
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Packer
        uses: hashicorp/setup-packer@main
        with:
          version: ${{ env.PACKER_VERSION }}

      - name: Check and Delete Existing Template
        id: check_template
        run: |
          VM_ID="${{ github.event.inputs.vm_id || '9000' }}"
          NODE="${{ secrets.PROXMOX_NODE || 'proxmox' }}"

          echo "Checking if VM/template with ID $VM_ID exists..."

          # Check if VM exists via Proxmox API
          HTTP_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_USERNAME }}=${{ secrets.PROXMOX_TOKEN }}" \
            "${{ secrets.PROXMOX_URL }}/api2/json/nodes/$NODE/qemu/$VM_ID/status/current")

          if [ "$HTTP_CODE" = "200" ]; then
            echo "VM/template with ID $VM_ID found. Deleting..."

            # First, stop the VM if it's running
            VM_STATUS=$(curl -k -s \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_USERNAME }}=${{ secrets.PROXMOX_TOKEN }}" \
              "${{ secrets.PROXMOX_URL }}/api2/json/nodes/$NODE/qemu/$VM_ID/status/current" | grep -o '"status":"[^"]*"' | cut -d'"' -f4)

            if [ "$VM_STATUS" = "running" ]; then
              echo "VM is running, stopping it first..."
              curl -k -X POST \
                -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_USERNAME }}=${{ secrets.PROXMOX_TOKEN }}" \
                "${{ secrets.PROXMOX_URL }}/api2/json/nodes/$NODE/qemu/$VM_ID/status/stop"
              sleep 10
            fi

            # Delete the VM/template
            DELETE_RESPONSE=$(curl -k -s -X DELETE \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_USERNAME }}=${{ secrets.PROXMOX_TOKEN }}" \
              "${{ secrets.PROXMOX_URL }}/api2/json/nodes/$NODE/qemu/$VM_ID")

            echo "Delete response: $DELETE_RESPONSE"

            # Wait for deletion to complete and verify
            echo "Waiting for deletion to complete..."
            sleep 10

            # Verify deletion
            VERIFY_CODE=$(curl -k -s -o /dev/null -w "%{http_code}" \
              -H "Authorization: PVEAPIToken=${{ secrets.PROXMOX_USERNAME }}=${{ secrets.PROXMOX_TOKEN }}" \
              "${{ secrets.PROXMOX_URL }}/api2/json/nodes/$NODE/qemu/$VM_ID/status/current")

            if [ "$VERIFY_CODE" = "200" ]; then
              echo "ERROR: VM $VM_ID still exists after deletion attempt!"
              exit 1
            else
              echo "VM/template $VM_ID deleted successfully"
            fi
          else
            echo "VM/template with ID $VM_ID does not exist"
          fi

          echo "Proceeding with build..."

      - name: Install Dependencies
        run: |
          if ! command -v xorriso &> /dev/null; then
            sudo apt-get update
            sudo apt-get install -y xorriso
          fi

      - name: Initialize Packer
        working-directory: ${{ env.WORKING_DIR }}
        run: packer init ubuntu-2404.pkr.hcl

      - name: Create Variables File
        working-directory: ${{ env.WORKING_DIR }}
        run: |
          VM_ID="${{ github.event.inputs.vm_id || '9000' }}"
          cat > variables.pkrvars.hcl << EOF
          # Proxmox connection details
          proxmox_url      = "${{ secrets.PROXMOX_URL }}"
          proxmox_username = "${{ secrets.PROXMOX_USERNAME || 'root@pam!packer' }}"

          # VM template configuration
          vm_id        = "$VM_ID"
          proxmox_node = "${{ secrets.PROXMOX_NODE || 'proxmox' }}"

          # ISO and installation settings
          iso_file     = "local:iso/ubuntu-24.04.2-live-server-amd64.iso"
          ssh_username = "ubuntu"
          EOF

      - name: Build Packer Template
        working-directory: ${{ env.WORKING_DIR }}
        env:
          PACKER_LOG: 1
          PACKER_LOG_PATH: "/tmp/packer.log"
        run: |
          packer build \
            -var "proxmox_token=${{ secrets.PROXMOX_TOKEN }}" \
            -var "ssh_password=${{ secrets.SSH_PASSWORD }}" \
            -var-file="variables.pkrvars.hcl" \
            ubuntu-2404.pkr.hcl

      - name: Cleanup Temporary Files
        if: always()
        working-directory: ${{ env.WORKING_DIR }}
        run: rm -f variables.pkrvars.hcl

      - name: Upload Packer Logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: packer-logs-${{ github.run_number }}
          path: /tmp/packer.log
          retention-days: 7

      - name: Template Build Summary
        if: success()
        run: |
          VM_ID="${{ github.event.inputs.vm_id || '9000' }}"
          echo "## ðŸŽ‰ Packer Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "- **Template ID:** $VM_ID" >> $GITHUB_STEP_SUMMARY
          echo "- **Template Name:** ubuntu-2404-template" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Status:** âœ… Success" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Time:** $(date)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The Ubuntu 24.04 template is now available in Proxmox and ready for use!" >> $GITHUB_STEP_SUMMARY
